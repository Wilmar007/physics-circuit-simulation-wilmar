<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parallel Circuit Simulator</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;800;900&family=Rajdhani:wght@500;600;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    body {
      font-family: 'Rajdhani', sans-serif;
      background: #0a0118;
      color: #e0e7ff;
      position: relative;
    }
    
    .main-wrapper {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
    }
    
    /* Animated electric background */
    .electric-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    
    .bg-glow {
      position: absolute;
      border-radius: 50%;
      filter: blur(120px);
      opacity: 0.12;
      animation: pulse-glow 10s ease-in-out infinite;
    }
    
    .bg-glow:nth-child(1) {
      width: 500px;
      height: 500px;
      background: #00ffff;
      top: 5%;
      left: 15%;
      animation-delay: 0s;
    }
    
    .bg-glow:nth-child(2) {
      width: 450px;
      height: 450px;
      background: #ff00ff;
      bottom: 10%;
      right: 20%;
      animation-delay: 4s;
    }
    
    .bg-glow:nth-child(3) {
      width: 400px;
      height: 400px;
      background: #00ff88;
      top: 45%;
      left: 55%;
      animation-delay: 7s;
    }
    
    @keyframes pulse-glow {
      0%, 100% { opacity: 0.12; transform: scale(1); }
      50% { opacity: 0.22; transform: scale(1.15); }
    }
    
    /* Content Layer */
    .content-layer {
      position: relative;
      z-index: 1;
      padding: 20px;
      min-height: 100%;
    }
    
    /* Header */
    .main-header {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.8rem;
      font-weight: 900;
      text-align: center;
      margin-bottom: 20px;
      color: #00ffff;
      text-shadow: 0 0 25px rgba(0, 255, 255, 0.8), 0 0 50px rgba(0, 255, 255, 0.4);
      letter-spacing: 2px;
    }
    
    /* Circuit Panel */
    .circuit-panel {
      background: rgba(10, 5, 25, 0.85);
      border: 3px solid rgba(0, 255, 255, 0.4);
      border-radius: 16px;
      padding: 25px;
      backdrop-filter: blur(12px);
      margin-bottom: 15px;
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
    }
    
    .circuit-canvas {
      width: 100%;
      height: 100%;
      min-height: 500px;
    }
    
    /* Control Buttons */
    .control-row {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .btn {
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      padding: 12px 28px;
      border-radius: 10px;
      border: 2px solid;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-add {
      background: rgba(0, 255, 136, 0.15);
      border-color: #00ff88;
      color: #00ff88;
    }
    
    .btn-add:hover {
      background: rgba(0, 255, 136, 0.25);
      box-shadow: 0 0 25px rgba(0, 255, 136, 0.6);
      transform: translateY(-2px);
    }
    
    .btn-remove {
      background: rgba(255, 0, 136, 0.15);
      border-color: #ff0088;
      color: #ff0088;
    }
    
    .btn-remove:hover {
      background: rgba(255, 0, 136, 0.25);
      box-shadow: 0 0 25px rgba(255, 0, 136, 0.6);
      transform: translateY(-2px);
    }
    
    .btn-toggle {
      background: rgba(0, 255, 255, 0.15);
      border-color: #00ffff;
      color: #00ffff;
    }
    
    .btn-toggle:hover {
      background: rgba(0, 255, 255, 0.25);
      box-shadow: 0 0 25px rgba(0, 255, 255, 0.6);
      transform: translateY(-2px);
    }
    
    /* Calculations Panel */
    .calculations-panel {
      background: rgba(10, 5, 25, 0.85);
      border: 3px solid rgba(255, 0, 255, 0.4);
      border-radius: 16px;
      padding: 25px;
      backdrop-filter: blur(12px);
      margin-bottom: 15px;
      box-shadow: 0 0 30px rgba(255, 0, 255, 0.2);
    }
    
    .calc-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.8rem;
      font-weight: 800;
      color: #ff00ff;
      margin-bottom: 20px;
      text-align: center;
      text-shadow: 0 0 20px rgba(255, 0, 255, 0.6);
    }
    
    .calc-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
    }
    
    .calc-item {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.08), rgba(255, 0, 255, 0.08));
      border-left: 4px solid #00ffff;
      padding: 15px;
      border-radius: 8px;
    }
    
    .calc-item-label {
      font-size: 0.95rem;
      color: #a5b4fc;
      margin-bottom: 6px;
      font-weight: 600;
    }
    
    .calc-item-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.6rem;
      font-weight: 800;
      color: #00ff88;
      text-shadow: 0 0 10px rgba(0, 255, 136, 0.6);
    }
    
    .calc-total {
      border-left-color: #ff00ff;
      background: linear-gradient(135deg, rgba(255, 0, 255, 0.15), rgba(0, 255, 255, 0.08));
    }
    
    .calc-total .calc-item-value {
      color: #ff00ff;
      text-shadow: 0 0 10px rgba(255, 0, 255, 0.6);
    }
    
    /* How To Panel */
    .info-panel {
      background: rgba(10, 5, 25, 0.85);
      border: 3px solid rgba(0, 255, 136, 0.4);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(12px);
      box-shadow: 0 0 30px rgba(0, 255, 136, 0.2);
    }
    
    .info-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: #00ff88;
      margin-bottom: 15px;
      text-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
    }
    
    .info-panel p, .info-panel li {
      line-height: 1.7;
      margin-bottom: 10px;
      color: #cbd5e1;
      font-size: 1rem;
    }
    
    .info-panel ul {
      margin-left: 20px;
      margin-bottom: 12px;
    }
    
    /* SVG Styles */
    .wire {
      stroke: #00ffff;
      stroke-width: 20;
      fill: none;
      filter: drop-shadow(0 0 8px rgba(0, 255, 255, 0.8));
    }
    
    .junction-point {
      fill: #00ff88;
      filter: drop-shadow(0 0 8px rgba(0, 255, 136, 1));
    }
    
    .battery-terminal {
      stroke: #ff00ff;
      stroke-width: 6;
      stroke-linecap: round;
      filter: drop-shadow(0 0 8px rgba(255, 0, 255, 0.8));
    }
    
    .resistor-shape {
      stroke: #00ffff;
      stroke-width: 3;
      fill: none;
      filter: drop-shadow(0 0 5px rgba(0, 255, 255, 0.6));
    }
    
    .circuit-electron {
      fill: #ff0044;
      filter: drop-shadow(0 0 8px rgba(255, 0, 68, 1));
    }
    
    .circuit-label {
      font-family: 'Orbitron', monospace;
      font-size: 14px;
      fill: #a5b4fc;
      font-weight: 600;
    }
    
    .circuit-value {
      font-family: 'Orbitron', monospace;
      font-size: 15px;
      fill: #00ff88;
      font-weight: 700;
      filter: drop-shadow(0 0 5px rgba(0, 255, 136, 0.6));
    }
    
    .bulb-glow {
      filter: drop-shadow(0 0 20px rgba(0, 255, 136, 1));
    }
    
    .bulb-off {
      opacity: 0.25;
    }
    
    /* Slider Controls */
    .slider-container {
      margin: 15px 0;
    }
    
    .slider-label {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.1rem;
      color: #00ffff;
      margin-bottom: 8px;
      display: block;
      font-weight: 600;
    }
    
    .slider-input {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(90deg, rgba(0, 255, 255, 0.3), rgba(255, 0, 255, 0.3));
      outline: none;
      -webkit-appearance: none;
    }
    
    .slider-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00ffff, #ff00ff);
      cursor: pointer;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.9);
      transition: transform 0.2s;
    }
    
    .slider-input::-webkit-slider-thumb:hover {
      transform: scale(1.15);
    }
    
    .slider-input::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00ffff, #ff00ff);
      cursor: pointer;
      border: none;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.9);
      transition: transform 0.2s;
    }
    
    .slider-input::-moz-range-thumb:hover {
      transform: scale(1.15);
    }
    
    .value-display {
      font-family: 'Orbitron', sans-serif;
      margin-top: 8px;
      font-size: 1.5rem;
      font-weight: 800;
      color: #00ff88;
      text-align: center;
      text-shadow: 0 0 10px rgba(0, 255, 136, 0.6);
    }
    
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    /* === CONTROL SIMULATOR HEIGHT === */
.simulator-layout {
  min-height: 100vh;        /* full screen height */
  height: auto;
}

.circuit-container {
  min-height: 75vh;         /* üëà circuit area height */
}
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full"><!-- Animated Electric Background -->
  <div class="electric-background">
   <div class="bg-glow"></div>
   <div class="bg-glow"></div>
   <div class="bg-glow"></div>
  </div>
  <div class="main-wrapper">
   <div class="content-layer">
    <h1 class="main-header" id="main-title">‚ö° PARALLEL CIRCUIT SIMULATOR ‚ö°</h1><!-- How-to-Use Panel at TOP -->
    <div class="info-panel" id="howto-panel">
     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h2 class="info-title" id="how-to-title" style="margin-bottom: 0;">üìò How to Use This Simulator</h2><button class="btn btn-toggle" id="toggle-howto-btn" style="padding: 8px 20px;">SHOW</button>
     </div>
     <div id="howto-content" style="display: none;">
      <ul>
       <li><strong>Electron Flow:</strong> Watch electrons flow from battery (‚àí) ‚Üí UP ‚Üí RIGHT along top rail ‚Üí DOWN through branches ‚Üí LEFT along bottom rail ‚Üí back to battery (+).</li>
       <li><strong>Kirchhoff's Current Law:</strong> Current splits at junctions. Top rail current decreases after each split. Bottom rail current increases as currents rejoin.</li>
       <li><strong>Add/Remove Branches:</strong> Use buttons to add (max 6) or remove (min 2) branches. Each branch has its own resistor and bulb.</li>
       <li><strong>Adjust Voltage:</strong> Control battery voltage from 0V to 24V. Higher voltage = more current = brighter bulbs.</li>
       <li><strong>Adjust Resistance:</strong> Each branch has independent resistance control. Lower resistance = higher current = brighter bulb.</li>
       <li><strong>Visual Feedback:</strong> Electron speed shows current strength. Bulb brightness shows power dissipation. Watch currents add up correctly!</li>
      </ul>
     </div>
    </div><!-- Main Layout: Controls LEFT, Circuit RIGHT -->
    <div style="display: grid; grid-template-columns: 320px 1fr; gap: 20px; margin-bottom: 20px;"><!-- LEFT: Controls Panel -->
     <div>
      <div class="calculations-panel" style="margin-bottom: 0;">
       <h2 class="calc-title">‚öôÔ∏è CONTROLS</h2>
       <div class="slider-container"><label class="slider-label" for="voltage-control">Voltage (V)</label> <input type="range" min="0" max="24" value="12" step="0.5" class="slider-input" id="voltage-control">
        <div class="value-display" id="voltage-value">
         12.0 V
        </div>
       </div>
       <div id="branch-sliders-container"></div>
       <div style="margin-top: 20px;"><button class="btn btn-add" id="add-branch-btn" style="width: 100%; margin-bottom: 10px;">‚ûï ADD BRANCH</button> <button class="btn btn-remove" id="remove-branch-btn" style="width: 100%;">‚ûñ REMOVE BRANCH</button>
       </div>
      </div>
     </div><!-- RIGHT: Circuit Display -->
     <div class="circuit-panel" style="margin-bottom: 0;">
      <svg class="circuit-canvas" id="circuit-svg" viewbox="0 0 1000 550"></svg>
     </div>
    </div><!-- Bottom: Live Calculations with Formulas -->
    <div class="calculations-panel">
     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 class="calc-title" style="margin-bottom: 0;">üìä LIVE CALCULATIONS &amp; FORMULAS</h2><button class="btn btn-toggle" id="toggle-calc-btn" style="padding: 8px 20px;">SHOW</button>
     </div>
     <div id="calc-content" style="display: none;">
      <div style="margin-bottom: 25px;">
       <h3 style="color: #00ffff; font-size: 1.3rem; margin-bottom: 15px; font-family: 'Orbitron', sans-serif;">‚ö° Given Values:</h3>
       <div class="calc-grid" id="given-values"></div>
      </div>
      <div style="margin-bottom: 25px;">
       <h3 style="color: #00ffff; font-size: 1.3rem; margin-bottom: 15px; font-family: 'Orbitron', sans-serif;">üî¨ Calculate Branch Currents (Ohm's Law):</h3>
       <div style="background: rgba(0, 255, 255, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #00ffff; margin-bottom: 15px;">
        <div style="font-family: 'Orbitron', monospace; font-size: 1.1rem; color: #00ff88; margin-bottom: 8px;"><strong>Formula: I = V / R</strong>
        </div>
        <div style="color: #cbd5e1; font-size: 0.95rem;">
         Where I = current (Amperes), V = voltage (Volts), R = resistance (Ohms)
        </div>
       </div>
       <div id="branch-calculations"></div>
      </div>
      <div style="margin-bottom: 25px;">
       <h3 style="color: #00ffff; font-size: 1.3rem; margin-bottom: 15px; font-family: 'Orbitron', sans-serif;">‚ûï Calculate Total Current (Kirchhoff's Current Law):</h3>
       <div style="background: rgba(0, 255, 255, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #00ffff; margin-bottom: 15px;">
        <div style="font-family: 'Orbitron', monospace; font-size: 1.1rem; color: #00ff88; margin-bottom: 8px;"><strong>Formula: I<sub>T</sub> = I‚ÇÅ + I‚ÇÇ + I‚ÇÉ + I‚ÇÑ + ...</strong>
        </div>
        <div style="color: #cbd5e1; font-size: 0.95rem;">
         Total current equals the sum of all branch currents
        </div>
       </div>
       <div id="total-calculation"></div>
      </div>
      <div>
       <h3 style="color: #00ffff; font-size: 1.3rem; margin-bottom: 15px; font-family: 'Orbitron', sans-serif;">üí° Power Dissipation in Each Branch:</h3>
       <div style="background: rgba(0, 255, 255, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #00ffff; margin-bottom: 15px;">
        <div style="font-family: 'Orbitron', monospace; font-size: 1.1rem; color: #00ff88; margin-bottom: 8px;"><strong>Formula: P = V √ó I = V¬≤ / R</strong>
        </div>
        <div style="color: #cbd5e1; font-size: 0.95rem;">
         Power (Watts) shows how bright each bulb glows
        </div>
       </div>
       <div id="power-calculations"></div>
      </div>
     </div>
    </div><!-- Discussion Panel -->
    <div class="info-panel">
     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h2 class="info-title" id="discussion-title" style="margin-bottom: 0;">üìö Understanding Parallel Circuits</h2><button class="btn btn-toggle" id="toggle-discussion-btn" style="padding: 8px 20px;">SHOW</button>
     </div>
     <div id="discussion-content" style="display: none;">
      <h3 style="color: #00ff88; font-size: 1.2rem; margin: 20px 0 12px 0;">‚ö° What is a Parallel Circuit?</h3>
      <p>A parallel circuit is an electrical circuit where components are connected between two common points (rails), creating multiple independent paths for current to flow. Each path is called a "branch."</p>
      <h3 style="color: #00ff88; font-size: 1.2rem; margin: 20px 0 12px 0;">üîë Key Characteristics:</h3>
      <ul>
       <li><strong>Same Voltage Across All Branches:</strong> Every branch connects to the same two points (top rail and bottom rail), so all experience the full battery voltage.</li>
       <li><strong>Different Currents in Each Branch:</strong> Each branch draws current based on its own resistance using Ohm's Law (I = V/R).</li>
       <li><strong>Independent Operation:</strong> If one branch fails or is removed, other branches continue working normally.</li>
       <li><strong>Current Splits and Rejoins:</strong> At the top rail, total current splits into branches. At the bottom rail, branch currents rejoin to form the total current again.</li>
      </ul>
      <h3 style="color: #00ff88; font-size: 1.2rem; margin: 20px 0 12px 0;">üìê Kirchhoff's Current Law (KCL):</h3>
      <p>KCL states that the total current entering a junction must equal the total current leaving that junction. This is based on the conservation of charge - electrons cannot appear or disappear.</p>
      <ul>
       <li><strong>At Top Rail Junctions:</strong> Current splits. If 1.2A enters and Branch 1 takes 0.3A, then 0.9A continues to the next junction.</li>
       <li><strong>At Bottom Rail Junctions:</strong> Currents rejoin. Branch currents add back together to reform the total current.</li>
       <li><strong>Complete Loop:</strong> The current leaving the battery equals the current returning to the battery (I<sub>T</sub>).</li>
      </ul>
      <h3 style="color: #00ff88; font-size: 1.2rem; margin: 20px 0 12px 0;">üíß Water Pipe Analogy:</h3>
      <p>Think of the circuit as a water distribution system:</p>
      <ul>
       <li><strong>Battery = Water Pump:</strong> Creates pressure (voltage) that pushes water (electrons) through pipes (wires).</li>
       <li><strong>Top Rail = Distribution Pipe:</strong> High-pressure pipe where water splits into multiple paths.</li>
       <li><strong>Branches = Individual Pipes:</strong> Each has different width (resistance). Wide pipe (low R) = more flow. Narrow pipe (high R) = less flow.</li>
       <li><strong>Bottom Rail = Return Pipe:</strong> All water recombines and flows back to pump.</li>
       <li><strong>Light Bulbs:</strong> Devices that use the flow - brighter bulb = more flow (current) = more power.</li>
      </ul>
      <h3 style="color: #00ff88; font-size: 1.2rem; margin: 20px 0 12px 0;">üî¨ Why Same Voltage, Different Currents?</h3>
      <p><strong>Voltage stays the same</strong> because all branches connect to the same two points. The electrical "pressure" (potential difference) between top rail and bottom rail is fixed by the battery.</p>
      <p><strong>Currents differ</strong> because of Ohm's Law (I = V/R). With the same voltage:</p>
      <ul>
       <li>Low resistance branch (5Œ©) ‚Üí High current ‚Üí Bright bulb ‚Üí Electrons flow fast</li>
       <li>High resistance branch (50Œ©) ‚Üí Low current ‚Üí Dim bulb ‚Üí Electrons flow slow</li>
      </ul>
      <h3 style="color: #00ff88; font-size: 1.2rem; margin: 20px 0 12px 0;">üè† Real-Life Examples:</h3>
      <ul>
       <li><strong>Home Wiring:</strong> All outlets and lights are parallel. You can turn off one room's lights without affecting others. All devices get 120V (or 240V).</li>
       <li><strong>Car Electrical System:</strong> Headlights, radio, air conditioning all run in parallel from the 12V battery.</li>
       <li><strong>Holiday Lights (Modern):</strong> LED strings use parallel circuits so one burnt bulb doesn't darken the whole string.</li>
       <li><strong>Computer Motherboard:</strong> Multiple components (CPU, RAM, GPU) all receive the same voltage in parallel.</li>
      </ul>
      <h3 style="color: #00ff88; font-size: 1.2rem; margin: 20px 0 12px 0;">üß™ Experiments to Try:</h3>
      <ul>
       <li><strong>Equal Resistances:</strong> Set all branches to 10Œ© and observe equal currents and brightness.</li>
       <li><strong>One High Resistance:</strong> Set one branch to 50Œ© and others to 5Œ© - see how the high-resistance branch barely glows.</li>
       <li><strong>Add More Branches:</strong> Notice total current increases as you add branches (more paths = less total resistance).</li>
       <li><strong>Vary Voltage:</strong> Double the voltage and watch all currents double (linear relationship from Ohm's Law).</li>
       <li><strong>Remove a Branch:</strong> Delete a branch and see that others are unaffected - that's parallel circuit independence!</li>
      </ul>
      <h3 style="color: #00ff88; font-size: 1.2rem; margin: 20px 0 12px 0;">üìä Why Parallel Circuits Matter:</h3>
      <p>Parallel circuits are fundamental to modern electrical systems because:</p>
      <ul>
       <li><strong>Reliability:</strong> One component failure doesn't stop the whole system</li>
       <li><strong>Consistent Voltage:</strong> All devices receive the rated voltage they need</li>
       <li><strong>Independent Control:</strong> Each device can be switched on/off independently</li>
       <li><strong>Flexible Power Distribution:</strong> Easy to add or remove devices without redesigning</li>
      </ul>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      main_title: "‚ö° PARALLEL CIRCUIT SIMULATOR ‚ö°",
      how_to_title: "üìò How to Use This Simulator",
      discussion_title: "üìö Understanding Parallel Circuits"
    };

    let branches = [
      { id: 1, resistance: 10, bulbOn: true },
      { id: 2, resistance: 15, bulbOn: true },
      { id: 3, resistance: 20, bulbOn: true },
      { id: 4, resistance: 12, bulbOn: true }
    ];
    let nextBranchId = 5;
    let voltage = 12;
    let electronAnimations = [];

    function calculateBranchCurrent(resistance, bulbOn) {
      if (voltage === 0 || resistance === 0 || !bulbOn) return 0;
      return voltage / resistance;
    }

    function calculateTotalCurrent() {
      return branches.reduce((sum, branch) => sum + calculateBranchCurrent(branch.resistance, branch.bulbOn), 0);
    }

    function updateBranchSliders() {
      const container = document.getElementById('branch-sliders-container');
      container.innerHTML = '';
      
      branches.forEach((branch) => {
        const current = calculateBranchCurrent(branch.resistance, branch.bulbOn);
        
        const sliderDiv = document.createElement('div');
        sliderDiv.className = 'slider-container';
        sliderDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label class="slider-label" for="resistance-${branch.id}" style="margin-bottom: 0;">Branch ${branch.id} Resistance (Œ©)</label>
            <button class="btn ${branch.bulbOn ? 'btn-toggle' : 'btn-remove'}" id="toggle-bulb-${branch.id}" style="padding: 6px 16px; font-size: 0.85rem;">
              ${branch.bulbOn ? 'üí° ON' : 'üí° OFF'}
            </button>
          </div>
          <input type="range" min="1" max="50" value="${branch.resistance}" step="0.5" class="slider-input" id="resistance-${branch.id}" data-id="${branch.id}">
          <div class="value-display">${branch.resistance.toFixed(1)} Œ©</div>
          <div style="margin-top: 8px; text-align: center; font-size: 1.1rem; color: #00ffff;">I${branch.id} = ${current.toFixed(3)} A</div>
        `;
        
        container.appendChild(sliderDiv);
      });
      
      // Add event listeners for resistance sliders
      branches.forEach(branch => {
        const slider = document.getElementById(`resistance-${branch.id}`);
        if (slider) {
          slider.addEventListener('input', (e) => {
            const branchObj = branches.find(b => b.id === branch.id);
            if (branchObj) {
              branchObj.resistance = parseFloat(e.target.value);
              updateAll();
            }
          });
        }
        
        // Add event listener for bulb toggle button
        const toggleBtn = document.getElementById(`toggle-bulb-${branch.id}`);
        if (toggleBtn) {
          toggleBtn.addEventListener('click', () => {
            const branchObj = branches.find(b => b.id === branch.id);
            if (branchObj) {
              branchObj.bulbOn = !branchObj.bulbOn;
              updateAll();
            }
          });
        }
      });
    }

    function updateCalculationsDisplay() {
      // Given Values
      const givenContainer = document.getElementById('given-values');
      let givenHtml = `
        <div class="calc-item">
          <div class="calc-item-label">Battery Voltage (V)</div>
          <div class="calc-item-value">${voltage.toFixed(1)} V</div>
        </div>
      `;
      branches.forEach(branch => {
        givenHtml += `
          <div class="calc-item">
            <div class="calc-item-label">Branch ${branch.id} Resistance (R${branch.id})</div>
            <div class="calc-item-value">${branch.resistance.toFixed(1)} Œ©</div>
          </div>
        `;
      });
      givenContainer.innerHTML = givenHtml;
      
      // Branch Calculations (Ohm's Law for each branch)
      const branchContainer = document.getElementById('branch-calculations');
      let branchHtml = '';
      branches.forEach(branch => {
        const current = calculateBranchCurrent(branch.resistance, branch.bulbOn);
        const statusText = branch.bulbOn ? '' : ' <span style="color: #ff0088;">(BULB OFF)</span>';
        branchHtml += `
          <div style="background: rgba(0, 255, 136, 0.08); padding: 15px; border-radius: 8px; border-left: 4px solid #00ff88; margin-bottom: 12px;">
            <div style="font-family: 'Orbitron', monospace; font-size: 1.05rem; color: #00ffff; margin-bottom: 8px;">
              <strong>Branch ${branch.id}:</strong> I${branch.id} = V / R${branch.id}${statusText}
            </div>
            <div style="font-family: 'Orbitron', monospace; font-size: 1.05rem; color: #cbd5e1; margin-bottom: 8px;">
              I${branch.id} = ${voltage.toFixed(1)} / ${branch.resistance.toFixed(1)} = <span style="color: #00ff88; font-weight: 700;">${current.toFixed(3)} A</span>
            </div>
          </div>
        `;
      });
      branchContainer.innerHTML = branchHtml;
      
      // Total Current Calculation
      const totalContainer = document.getElementById('total-calculation');
      const totalCurrent = calculateTotalCurrent();
      const branchIds = branches.map(b => `I${b.id}`).join(' + ');
      const branchValues = branches.map(b => calculateBranchCurrent(b.resistance).toFixed(3)).join(' + ');
      
      totalContainer.innerHTML = `
        <div style="background: rgba(255, 0, 255, 0.08); padding: 15px; border-radius: 8px; border-left: 4px solid #ff00ff;">
          <div style="font-family: 'Orbitron', monospace; font-size: 1.05rem; color: #00ffff; margin-bottom: 8px;">
            <strong>Total Current:</strong> I<sub>T</sub> = ${branchIds}
          </div>
          <div style="font-family: 'Orbitron', monospace; font-size: 1.05rem; color: #cbd5e1; margin-bottom: 8px;">
            I<sub>T</sub> = ${branchValues}
          </div>
          <div style="font-family: 'Orbitron', monospace; font-size: 1.3rem; color: #ff00ff; font-weight: 800;">
            I<sub>T</sub> = ${totalCurrent.toFixed(3)} A
          </div>
        </div>
      `;
      
      // Power Calculations
      const powerContainer = document.getElementById('power-calculations');
      let powerHtml = '';
      branches.forEach(branch => {
        const current = calculateBranchCurrent(branch.resistance, branch.bulbOn);
        const power = voltage * current;
        const statusText = branch.bulbOn ? '' : ' <span style="color: #ff0088;">(OFF)</span>';
        powerHtml += `
          <div style="background: rgba(0, 255, 136, 0.08); padding: 15px; border-radius: 8px; border-left: 4px solid #00ff88; margin-bottom: 12px;">
            <div style="font-family: 'Orbitron', monospace; font-size: 1.05rem; color: #00ffff; margin-bottom: 8px;">
              <strong>Branch ${branch.id}:</strong> P${branch.id} = V √ó I${branch.id} = ${voltage.toFixed(1)} √ó ${current.toFixed(3)}${statusText}
            </div>
            <div style="font-family: 'Orbitron', monospace; font-size: 1.05rem; color: #cbd5e1;">
              P${branch.id} = <span style="color: #00ff88; font-weight: 700;">${power.toFixed(3)} W</span> (Bulb ${branch.id} brightness)
            </div>
          </div>
        `;
      });
      powerContainer.innerHTML = powerHtml;
    }

    function drawCircuit() {
      const svg = document.getElementById('circuit-svg');
      
      // Stop existing animations
      electronAnimations.forEach(anim => {
        if (anim && anim.stop) anim.stop();
      });
      electronAnimations = [];
      
      svg.innerHTML = '';
      
      const width = 1000;
      const height = 550;
      
      // Layout: Battery on LEFT, rectangular loop
      const batteryX = 80;
      const batteryTopY = 100;
      const batteryBottomY = height - 100;
      const batteryHeight = batteryBottomY - batteryTopY;
      
      const loopLeft = 180;
      const loopRight = width - 80;
      const loopTop = 100;
      const loopBottom = height - 100;
      
      // === STEP 1: Draw the complete rectangular loop (wires only, no components) ===
      
      // LEFT vertical wire (battery negative to top-left corner)
      const leftWireTop = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      leftWireTop.setAttribute('x1', batteryX);
      leftWireTop.setAttribute('y1', batteryBottomY);
      leftWireTop.setAttribute('x2', batteryX);
      leftWireTop.setAttribute('y2', loopTop);
      leftWireTop.setAttribute('class', 'wire');
      svg.appendChild(leftWireTop);
      
      // Horizontal connector from battery to loop-left
      const connectorTopLeft = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      connectorTopLeft.setAttribute('x1', batteryX);
      connectorTopLeft.setAttribute('y1', loopTop);
      connectorTopLeft.setAttribute('x2', loopLeft);
      connectorTopLeft.setAttribute('y2', loopTop);
      connectorTopLeft.setAttribute('class', 'wire');
      svg.appendChild(connectorTopLeft);
      
      // TOP RAIL (horizontal, where current flows and splits)
      const topRail = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      topRail.setAttribute('x1', loopLeft);
      topRail.setAttribute('y1', loopTop);
      topRail.setAttribute('x2', loopRight);
      topRail.setAttribute('y2', loopTop);
      topRail.setAttribute('class', 'wire');
      svg.appendChild(topRail);
      
      // RIGHT vertical wire (completing the loop down)
      const rightWire = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      rightWire.setAttribute('x1', loopRight);
      rightWire.setAttribute('y1', loopTop);
      rightWire.setAttribute('x2', loopRight);
      rightWire.setAttribute('y2', loopBottom);
      rightWire.setAttribute('class', 'wire');
      svg.appendChild(rightWire);
      
      // BOTTOM RAIL (horizontal, where currents rejoin)
      const bottomRail = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      bottomRail.setAttribute('x1', loopRight);
      bottomRail.setAttribute('y1', loopBottom);
      bottomRail.setAttribute('x2', loopLeft);
      bottomRail.setAttribute('y2', loopBottom);
      bottomRail.setAttribute('class', 'wire');
      svg.appendChild(bottomRail);
      
      // Horizontal connector from loop-left back to battery
      const connectorBottomLeft = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      connectorBottomLeft.setAttribute('x1', loopLeft);
      connectorBottomLeft.setAttribute('y1', loopBottom);
      connectorBottomLeft.setAttribute('x2', batteryX);
      connectorBottomLeft.setAttribute('y2', loopBottom);
      connectorBottomLeft.setAttribute('class', 'wire');
      svg.appendChild(connectorBottomLeft);
      
      // LEFT vertical wire bottom (battery positive connection)
      const leftWireBottom = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      leftWireBottom.setAttribute('x1', batteryX);
      leftWireBottom.setAttribute('y1', loopBottom);
      leftWireBottom.setAttribute('x2', batteryX);
      leftWireBottom.setAttribute('y2', batteryTopY);
      leftWireBottom.setAttribute('class', 'wire');
      svg.appendChild(leftWireBottom);
      
      // === STEP 2: Draw Battery (Standard Symbol) ===
      
      const batteryGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      
      // Battery background box
      const batteryBox = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      batteryBox.setAttribute('x', batteryX - 45);
      batteryBox.setAttribute('y', batteryTopY - 10);
      batteryBox.setAttribute('width', 90);
      batteryBox.setAttribute('height', batteryHeight + 20);
      batteryBox.setAttribute('fill', 'rgba(10, 5, 25, 0.7)');
      batteryBox.setAttribute('stroke', 'rgba(255, 0, 255, 0.4)');
      batteryBox.setAttribute('stroke-width', '2');
      batteryBox.setAttribute('rx', '10');
      svg.appendChild(batteryBox);
      
      // POSITIVE terminal (TOP - longer line)
      const posTerminal = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      posTerminal.setAttribute('x1', batteryX - 40);
      posTerminal.setAttribute('y1', batteryTopY);
      posTerminal.setAttribute('x2', batteryX + 40);
      posTerminal.setAttribute('y2', batteryTopY);
      posTerminal.setAttribute('class', 'battery-terminal');
      batteryGroup.appendChild(posTerminal);
      
      // NEGATIVE terminal (BOTTOM - shorter line)
      const negTerminal = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      negTerminal.setAttribute('x1', batteryX - 28);
      negTerminal.setAttribute('y1', batteryBottomY);
      negTerminal.setAttribute('x2', batteryX + 28);
      negTerminal.setAttribute('y2', batteryBottomY);
      negTerminal.setAttribute('class', 'battery-terminal');
      batteryGroup.appendChild(negTerminal);
      
      // + symbol at top
      const plusLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      plusLabel.setAttribute('x', batteryX + 55);
      plusLabel.setAttribute('y', batteryTopY + 8);
      plusLabel.setAttribute('class', 'circuit-value');
      plusLabel.setAttribute('font-size', '32');
      plusLabel.setAttribute('fill', '#ff00ff');
      plusLabel.textContent = '+';
      batteryGroup.appendChild(plusLabel);
      
      // ‚àí symbol at bottom
      const minusLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      minusLabel.setAttribute('x', batteryX + 45);
      minusLabel.setAttribute('y', batteryBottomY + 8);
      minusLabel.setAttribute('class', 'circuit-value');
      minusLabel.setAttribute('font-size', '32');
      minusLabel.setAttribute('fill', '#ff00ff');
      minusLabel.textContent = '‚àí';
      batteryGroup.appendChild(minusLabel);
      
      // Voltage label in center
      const vLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      vLabel.setAttribute('x', batteryX);
      vLabel.setAttribute('y', (batteryTopY + batteryBottomY) / 2 + 6);
      vLabel.setAttribute('class', 'circuit-value');
      vLabel.setAttribute('text-anchor', 'middle');
      vLabel.setAttribute('font-size', '24');
      vLabel.setAttribute('fill', '#00ff88');
      vLabel.textContent = `${voltage.toFixed(1)}V`;
      batteryGroup.appendChild(vLabel);
      
      svg.appendChild(batteryGroup);
      
      // === STEP 3: Draw vertical branches with resistors and bulbs ===
      
      const numBranches = branches.length;
      const availableWidth = loopRight - loopLeft - 100;
      const branchSpacing = availableWidth / (numBranches + 1);
      
      let currentAfterEachBranch = calculateTotalCurrent(); // Start with total current
      
      branches.forEach((branch, index) => {
        const branchX = loopLeft + 50 + (index + 1) * branchSpacing;
        const branchCurrent = calculateBranchCurrent(branch.resistance, branch.bulbOn);
        
        // Vertical wire connecting top rail to bottom rail
        const branchWire = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        branchWire.setAttribute('x1', branchX);
        branchWire.setAttribute('y1', loopTop);
        branchWire.setAttribute('x2', branchX);
        branchWire.setAttribute('y2', loopBottom);
        branchWire.setAttribute('class', 'wire');
        svg.appendChild(branchWire);
        
        // Junction points
        const topJunction = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        topJunction.setAttribute('cx', branchX);
        topJunction.setAttribute('cy', loopTop);
        topJunction.setAttribute('r', 7);
        topJunction.setAttribute('class', 'junction-point');
        svg.appendChild(topJunction);
        
        const bottomJunction = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        bottomJunction.setAttribute('cx', branchX);
        bottomJunction.setAttribute('cy', loopBottom);
        bottomJunction.setAttribute('r', 7);
        bottomJunction.setAttribute('class', 'junction-point');
        svg.appendChild(bottomJunction);
        
        // Resistor (zigzag pattern, upper third)
        const resistorTop = loopTop + 50;
        const resistorBottom = resistorTop + 60;
        const resistorPath = `M ${branchX},${loopTop + 20} L ${branchX - 18},${resistorTop} L ${branchX + 18},${resistorTop + 12} L ${branchX - 18},${resistorTop + 24} L ${branchX + 18},${resistorTop + 36} L ${branchX - 18},${resistorTop + 48} L ${branchX + 18},${resistorTop + 60} L ${branchX},${resistorBottom + 10}`;
        const resistor = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        resistor.setAttribute('d', resistorPath);
        resistor.setAttribute('class', 'resistor-shape');
        svg.appendChild(resistor);
        
        // Resistor label
        const resistorLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        resistorLabel.setAttribute('x', branchX + 30);
        resistorLabel.setAttribute('y', (resistorTop + resistorBottom) / 2);
        resistorLabel.setAttribute('class', 'circuit-label');
        resistorLabel.setAttribute('font-size', '14');
        resistorLabel.textContent = `R${branch.id}=${branch.resistance.toFixed(1)}Œ©`;
        svg.appendChild(resistorLabel);
        
        // Light bulb (lower third)
        const bulbY = loopBottom - 80;
        const bulbRadius = 25;
        
        const bulbCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        bulbCircle.setAttribute('cx', branchX);
        bulbCircle.setAttribute('cy', bulbY);
        bulbCircle.setAttribute('r', bulbRadius);
        bulbCircle.setAttribute('stroke', '#00ff88');
        bulbCircle.setAttribute('stroke-width', '3');
        
        if (voltage > 0 && branchCurrent > 0 && branch.bulbOn) {
          // Calculate brightness based on power (P = V √ó I)
          const power = voltage * branchCurrent;
          const maxPower = 24 * (24 / 1); // Max voltage √ó max current (24V / 1Œ©)
          const brightness = Math.min(power / maxPower, 1);
          
          // Fill opacity based on power - yellow glow
          const fillOpacity = 0.2 + (brightness * 0.8);
          bulbCircle.setAttribute('fill', `rgba(255, 220, 50, ${fillOpacity})`);
          
          // Dynamic yellow glow based on brightness
          const glowIntensity = 15 + (brightness * 40);
          bulbCircle.style.filter = `drop-shadow(0 0 ${glowIntensity}px rgba(255, 200, 0, ${0.7 + brightness * 0.3}))`;
        } else {
          bulbCircle.setAttribute('fill', 'rgba(60, 60, 60, 0.2)');
          bulbCircle.setAttribute('class', 'bulb-off');
        }
        svg.appendChild(bulbCircle);
        
        // Filament (X pattern)
        const filament1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        filament1.setAttribute('x1', branchX - 12);
        filament1.setAttribute('y1', bulbY - 12);
        filament1.setAttribute('x2', branchX + 12);
        filament1.setAttribute('y2', bulbY + 12);
        filament1.setAttribute('stroke', (voltage > 0 && branch.bulbOn) ? '#00ff88' : '#555');
        filament1.setAttribute('stroke-width', '2.5');
        svg.appendChild(filament1);
        
        const filament2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        filament2.setAttribute('x1', branchX - 12);
        filament2.setAttribute('y1', bulbY + 12);
        filament2.setAttribute('x2', branchX + 12);
        filament2.setAttribute('y2', bulbY - 12);
        filament2.setAttribute('stroke', (voltage > 0 && branch.bulbOn) ? '#00ff88' : '#555');
        filament2.setAttribute('stroke-width', '2.5');
        svg.appendChild(filament2);
        
        // Branch label
        const branchLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        branchLabel.setAttribute('x', branchX);
        branchLabel.setAttribute('y', loopTop - 50);
        branchLabel.setAttribute('class', 'circuit-label');
        branchLabel.setAttribute('text-anchor', 'middle');
        branchLabel.setAttribute('font-size', '15');
        branchLabel.setAttribute('font-weight', '700');
        branchLabel.textContent = `Branch ${branch.id}`;
        svg.appendChild(branchLabel);
        
        // Current label for this branch
        const currentLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        currentLabel.setAttribute('x', branchX - 40);
        currentLabel.setAttribute('y', bulbY);
        currentLabel.setAttribute('class', 'circuit-value');
        currentLabel.setAttribute('text-anchor', 'end');
        currentLabel.setAttribute('font-size', '14');
        currentLabel.textContent = `I${branch.id}=${branchCurrent.toFixed(3)}A`;
        svg.appendChild(currentLabel);
        
        // Animate electrons DOWN through this branch
        if (voltage > 0 && branchCurrent > 0 && branch.bulbOn) {
          animateBranchElectrons(svg, branchX, loopTop, loopBottom, branchCurrent);
        }
        
        // Show current on top rail AFTER this branch splits off
        currentAfterEachBranch -= branchCurrent;
        if (index < numBranches - 1) {
          const nextBranchX = loopLeft + 50 + (index + 2) * branchSpacing;
          const labelX = (branchX + nextBranchX) / 2;
          
          const topRailCurrentLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          topRailCurrentLabel.setAttribute('x', labelX);
          topRailCurrentLabel.setAttribute('y', loopTop - 15);
          topRailCurrentLabel.setAttribute('class', 'circuit-value');
          topRailCurrentLabel.setAttribute('text-anchor', 'middle');
          topRailCurrentLabel.setAttribute('font-size', '13');
          topRailCurrentLabel.textContent = `${currentAfterEachBranch.toFixed(3)}A ‚Üí`;
          svg.appendChild(topRailCurrentLabel);
        }
      });
      
      // === STEP 4: Add labels for rails and total current ===
      
      const totalCurrent = calculateTotalCurrent();
      
      // Total current label at start of top rail
      const totalCurrentLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      totalCurrentLabel.setAttribute('x', loopLeft + 40);
      totalCurrentLabel.setAttribute('y', loopTop - 15);
      totalCurrentLabel.setAttribute('class', 'circuit-value');
      totalCurrentLabel.setAttribute('font-size', '16');
      totalCurrentLabel.textContent = `IT=${totalCurrent.toFixed(3)}A ‚Üí`;
      svg.appendChild(totalCurrentLabel);
      
      // Top rail label
      const topRailLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      topRailLabel.setAttribute('x', (loopLeft + loopRight) / 2);
      topRailLabel.setAttribute('y', loopTop - 35);
      topRailLabel.setAttribute('class', 'circuit-label');
      topRailLabel.setAttribute('text-anchor', 'middle');
      topRailLabel.setAttribute('font-size', '13');
      topRailLabel.textContent = 'TOP RAIL (current splits at each junction)';
      svg.appendChild(topRailLabel);
      
      // Bottom rail label
      const bottomRailLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      bottomRailLabel.setAttribute('x', (loopLeft + loopRight) / 2);
      bottomRailLabel.setAttribute('y', loopBottom + 30);
      bottomRailLabel.setAttribute('class', 'circuit-label');
      bottomRailLabel.setAttribute('text-anchor', 'middle');
      bottomRailLabel.setAttribute('font-size', '13');
      bottomRailLabel.textContent = 'BOTTOM RAIL (currents rejoin)';
      svg.appendChild(bottomRailLabel);
      
      // === STEP 5: Animate electrons following the ONE CLOSED LOOP ===
      
      if (voltage > 0 && totalCurrent > 0) {
        // Path 1: UP the left wire (from battery ‚àí to top-left corner)
        animatePathElectrons(svg, batteryX, batteryBottomY, batteryX, loopTop, totalCurrent, 'vertical-up');
        
        // Path 2: Horizontal from battery to loop-left
        animatePathElectrons(svg, batteryX, loopTop, loopLeft, loopTop, totalCurrent, 'horizontal-right');
        
        // Path 3: Along TOP RAIL left-to-right (current decreases as branches split off)
        let currentRemaining = totalCurrent;
        let previousX = loopLeft;
        
        branches.forEach((branch, index) => {
          const branchX = loopLeft + 50 + (index + 1) * branchSpacing;
          const branchCurrent = calculateBranchCurrent(branch.resistance, branch.bulbOn);
          
          // Animate electrons from previous position to this branch
          animatePathElectrons(svg, previousX, loopTop, branchX, loopTop, currentRemaining, 'horizontal-right');
          
          // Update remaining current
          currentRemaining -= branchCurrent;
          previousX = branchX;
        });
        
        // Continue to right edge
        animatePathElectrons(svg, previousX, loopTop, loopRight, loopTop, currentRemaining, 'horizontal-right');
        
        // Path 4: DOWN the right wire
        animatePathElectrons(svg, loopRight, loopTop, loopRight, loopBottom, totalCurrent, 'vertical-down');
        
        // Path 5: Along BOTTOM RAIL right-to-left (current increases as branches rejoin)
        let currentAccumulated = 0;
        previousX = loopRight;
        
        for (let i = branches.length - 1; i >= 0; i--) {
          const branch = branches[i];
          const branchX = loopLeft + 50 + (i + 1) * branchSpacing;
          const branchCurrent = calculateBranchCurrent(branch.resistance, branch.bulbOn);
          
          currentAccumulated += branchCurrent;
          
          // Animate electrons from previous position to this branch
          animatePathElectrons(svg, previousX, loopBottom, branchX, loopBottom, currentAccumulated, 'horizontal-left');
          
          previousX = branchX;
        }
        
        // Continue to left edge
        animatePathElectrons(svg, previousX, loopBottom, loopLeft, loopBottom, totalCurrent, 'horizontal-left');
        
        // Path 6: Horizontal from loop-left back to battery
        animatePathElectrons(svg, loopLeft, loopBottom, batteryX, loopBottom, totalCurrent, 'horizontal-left');
        
        // Path 7: UP through battery (battery connection, no visible electrons here as they go through battery)
        // We skip animating inside the battery body itself
      }
    }

    function animateBranchElectrons(svg, x, topY, bottomY, current) {
      const baseSpeed = 0.004;
      const speedMultiplier = Math.sqrt(current) * 0.7 + 0.3;
      const speed = baseSpeed * speedMultiplier;
      
      const numElectrons = Math.max(2, Math.min(Math.ceil(current * 4), 10));
      
      for (let i = 0; i < numElectrons; i++) {
        const electron = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        electron.setAttribute('r', 5);
        electron.setAttribute('class', 'circuit-electron');
        svg.appendChild(electron);
        
        const delay = (i / numElectrons) * 1500;
        
        setTimeout(() => {
          const animation = {
            element: electron,
            phase: 0,
            x,
            startY: topY,
            endY: bottomY,
            speed,
            stopped: false,
            stop: function() {
              this.stopped = true;
              if (this.element && this.element.parentNode) {
                this.element.parentNode.removeChild(this.element);
              }
            }
          };
          
          const animate = () => {
            if (animation.stopped) return;
            
            animation.phase += animation.speed;
            if (animation.phase > 1) animation.phase = 0;
            
            const y = animation.startY + (animation.endY - animation.startY) * animation.phase;
            
            electron.setAttribute('cx', animation.x);
            electron.setAttribute('cy', y);
            
            requestAnimationFrame(animate);
          };
          
          animate();
          electronAnimations.push(animation);
        }, delay);
      }
    }

    function animatePathElectrons(svg, startX, startY, endX, endY, current, direction) {
      const baseSpeed = 0.005;
      const speedMultiplier = Math.sqrt(current) * 0.7 + 0.3;
      const speed = baseSpeed * speedMultiplier;
      
      const numElectrons = Math.max(3, Math.min(Math.ceil(current * 3), 12));
      
      for (let i = 0; i < numElectrons; i++) {
        const electron = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        electron.setAttribute('r', 5);
        electron.setAttribute('class', 'circuit-electron');
        svg.appendChild(electron);
        
        const delay = (i / numElectrons) * 1200;
        
        setTimeout(() => {
          const animation = {
            element: electron,
            phase: 0,
            startX,
            startY,
            endX,
            endY,
            speed,
            stopped: false,
            stop: function() {
              this.stopped = true;
              if (this.element && this.element.parentNode) {
                this.element.parentNode.removeChild(this.element);
              }
            }
          };
          
          const animate = () => {
            if (animation.stopped) return;
            
            animation.phase += animation.speed;
            if (animation.phase > 1) animation.phase = 0;
            
            const x = animation.startX + (animation.endX - animation.startX) * animation.phase;
            const y = animation.startY + (animation.endY - animation.startY) * animation.phase;
            
            electron.setAttribute('cx', x);
            electron.setAttribute('cy', y);
            
            requestAnimationFrame(animate);
          };
          
          animate();
          electronAnimations.push(animation);
        }, delay);
      }
    }

    function updateAll() {
      updateBranchSliders();
      updateCalculationsDisplay();
      drawCircuit();
    }

    // Event Listeners
    document.getElementById('voltage-control').addEventListener('input', (e) => {
      voltage = parseFloat(e.target.value);
      document.getElementById('voltage-value').textContent = `${voltage.toFixed(1)} V`;
      updateAll();
    });

    document.getElementById('add-branch-btn').addEventListener('click', () => {
      if (branches.length < 6) {
        branches.push({ id: nextBranchId++, resistance: 15, bulbOn: true });
        updateAll();
      } else {
        showToast('Maximum 6 branches allowed', '#ff0088');
      }
    });

    document.getElementById('remove-branch-btn').addEventListener('click', () => {
      if (branches.length > 2) {
        branches.pop();
        updateAll();
      } else {
        showToast('Minimum 2 branches required', '#ff0088');
      }
    });

    // Toggle buttons for collapsible sections
    document.getElementById('toggle-howto-btn').addEventListener('click', () => {
      const content = document.getElementById('howto-content');
      const btn = document.getElementById('toggle-howto-btn');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        btn.textContent = 'HIDE';
      } else {
        content.style.display = 'none';
        btn.textContent = 'SHOW';
      }
    });

    document.getElementById('toggle-calc-btn').addEventListener('click', () => {
      const content = document.getElementById('calc-content');
      const btn = document.getElementById('toggle-calc-btn');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        btn.textContent = 'HIDE';
      } else {
        content.style.display = 'none';
        btn.textContent = 'SHOW';
      }
    });

    document.getElementById('toggle-discussion-btn').addEventListener('click', () => {
      const content = document.getElementById('discussion-content');
      const btn = document.getElementById('toggle-discussion-btn');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        btn.textContent = 'HIDE';
      } else {
        content.style.display = 'none';
        btn.textContent = 'SHOW';
      }
    });

    function showToast(message, color) {
      const toast = document.createElement('div');
      toast.textContent = message;
      toast.style.cssText = `position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: ${color}; color: white; padding: 20px 40px; border-radius: 12px; font-size: 1.2rem; font-weight: 700; z-index: 1000; box-shadow: 0 0 40px ${color}; font-family: Orbitron, sans-serif;`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }

    // Element SDK Implementation
    async function onConfigChange(config) {
      const mainTitle = config.main_title || defaultConfig.main_title;
      const howToTitle = config.how_to_title || defaultConfig.how_to_title;
      const discussionTitle = config.discussion_title || defaultConfig.discussion_title;
      
      document.getElementById('main-title').textContent = mainTitle;
      document.getElementById('how-to-title').textContent = howToTitle;
      document.getElementById('discussion-title').textContent = discussionTitle;
    }

    // Initialize
    function init() {
      updateBranchSliders();
      updateCalculationsDisplay();
      drawCircuit();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // Initialize Element SDK if available
    (async function() {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ["main_title", config.main_title || defaultConfig.main_title],
            ["how_to_title", config.how_to_title || defaultConfig.how_to_title],
            ["discussion_title", config.discussion_title || defaultConfig.discussion_title]
          ])
        });
      }
    })();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c6a69bce5886e8f',t:'MTc2OTg3NTEzMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>